//Electric Field Hockey.js
!function(a){var b=a.EFH||{};"undefined"==typeof a.EFH&&(a.EFH=b);var c=function(a,b){if(b)for(var c in b)a.hasOwnProperty(c)&&(a[c]=b[c])},d={images:{}},e=function(){var a=[{name:"puck",source:"/img/puck.png",type:"image"},{name:"positive",source:"/img/positive.png",type:"image"},{name:"negative",source:"/img/negative.png",type:"image"}],b=0,c=function(c,e,f){b++,"image"===c.type&&(d.images[c.name]=e),b===a.length&&f()};return function(b,d){var e=b||{},f=e.rootDir||"";a.forEach(function(a){if("image"===a.type){var b=new Image;b.onload=function(){c(a,b,d)},b.src=f+a.source}})}}(),f=function(a,c){this.charge=new b.PointCharge({x:a,y:c,charge:1}),this.velocity=b.Vector.ZERO,this.shape=new Kinetic.Image({x:a-20,y:c-20,image:d.images.puck})};f.prototype.moveTo=function(a,b){this.charge.x=a,this.charge.y=b,this.shape.setPosition(a-20,b-20)},f.prototype.getX=function(){return this.charge.x},f.prototype.getY=function(){return this.charge.y},f.prototype.getRadius=function(){return 20};var g=20,h=function(a,c,e){var f=this,h=new b.PointCharge({x:a,y:c,charge:e}),i=new Kinetic.Image({x:a-g,y:c-g,image:e>=0?d.images.positive:d.images.negative,draggable:!0,name:"draggablepoint"});i.createImageHitRegion(),i.on("dragend",function(){h.x=this.getX()+g,h.y=this.getY()+g,"function"==typeof f.onDragEnd&&f.onDragEnd()}),i.on("mousedown touchstart",function(){i.moveToTop()}),this.charge=h,this.shape=i};h.prototype.getX=function(){return this.charge.x},h.prototype.getY=function(){return this.charge.y},h.prototype.getRadius=function(){return g};var i=function(){this.name="Level",this.goal={x:0,y:0,width:25,height:100},this.background={url:null,image:null},this.puckPosition={x:0,y:0},this.startingCharges=[1,-1,1,-1,1,-1],this.width=0,this.height=0};i.load=function(a,b){"string"==typeof a?i.loadJson(a,b):i.loadObject(a,b)},i.loadObject=function(a,b){var d=new i;c(d,a),d.height=+d.height,d.width=+d.width,d.goal.x=+d.goal.x,d.goal.y=+d.goal.y,d.goal.width=+d.goal.width,d.goal.height=+d.goal.height,d.puckPosition.x=+d.puckPosition.x,d.puckPosition.y=+d.puckPosition.y,"string"==typeof a.startingCharges&&(d.startingCharges=a.startingCharges.split(",").map(function(a){return+a})),a.backgroundUrl?(d.background.url=a.backgroundUrl,d.background.image=new Image,d.background.image.onload=function(){b(d)},d.background.image.src=d.background.url):b(d)},i.loadJson=function(){throw"NOT IMPLEMENTED"};var j=function(a){this.stage=null,this.layer=null,this.puckLayer=null,this.anim=null,this.puck=null,this.map=null,this.txt=null,this.events={lose:[],win:[],stop:[]},this.options={container:"efh-simulation"},c(this.options,a)};j.prototype.init=function(a){var b=this;return i.load(a,function(a){b.stage=new Kinetic.Stage({width:a.width+100,height:a.height,container:b.options.container}),b.layer=new Kinetic.Layer,b.puckLayer=new Kinetic.Layer,b.puck=new f(100+a.puckPosition.x,a.puckPosition.y),b.puckLayer.add(b.puck.shape),b.goal=new Kinetic.Rect({x:a.goal.x+100,y:a.goal.y,width:a.goal.width,height:a.goal.height,fill:"green"}),b.layer.add(b.goal),b.txt=new Kinetic.Text({x:b.stage.getWidth()-200,y:15,text:"",fontSize:10,fontFamily:"Calibri",fill:"green"}),b.layer.add(b.txt);var c=100,d=0,e=a.width,g=a.height,h=new Kinetic.Line({points:[c,d,c+e,d,c+e,d+g,c,d+g,c,d],stroke:"black",strokeWidth:2});if(b.layer.add(h),b.addInitialCharges(a.startingCharges),a.background.image){var i=new Kinetic.Image({image:a.background.image,x:c,y:d,width:e,height:g});b.layer.add(i),i.moveToBottom(),i.createImageHitRegion(function(){b.layer.draw()})}b.map=a,b.stage.add(b.layer),b.stage.add(b.puckLayer),b.anim=b.createAnimation(),b.layer.draw(),b.puckLayer.draw()}),b},j.prototype.debug=function(a){this.txt.setText(a)},j.prototype.isCollision=function(a,b,c){for(var d=8,e=0,f=c+0,g=0;d>g;g++){var h=a+f*Math.cos(e),i=b+f*Math.sin(e),j=this.layer.getIntersection(h,i);if(j&&j.shape&&j.shape!==this.puck.shape)return j.shape;e+=2*Math.PI/d}return!1},j.prototype.checkState=function(a,b){var c=this.isCollision(a.position.x,a.position.y,this.puck.getRadius());return c?(this.render(a,b.frameRate),this.handleCollision(c),void 0):(this.isOffScreen(a.position.x,a.position.y)&&this.handleCollision("screen"),void 0)},j.prototype.isOffScreen=function(a,b){return a>100+this.map.width||100>a||b>this.map.height||0>b},j.prototype.createAnimation=function(){var a=this,c={position:{x:a.puck.getX(),y:a.puck.getY()},velocity:a.puck.velocity,acceleration:b.Vector.ZERO,charge:a.puck.charge},d=new b.Simulation(c,function(b,c){a.checkState(b,c)}),e=new Kinetic.Animation(function(b){if(0!==b.timeDiff){var c=d.handleFrameRequest(b);a.render(c,b.frameRate)}},a.layer);return e.simulation=d,e},j.prototype.render=function(a,b){this.puck.velocity=a.velocity,this.puck.moveTo(a.position.x,a.position.y),this.puckLayer.draw(),this.debug("FPS: "+b)},j.prototype.handleCollision=function(a){this.stop(),a!==!1?(console.log(a),a==this.goal?this.fire("win"):this.fire("lose")):this.fire("lose")},j.prototype.addInitialCharges=function(a){for(var b=25,c=25,d=0;d<a.length;d++)this.addCharge(b,c,a[d]),c+=20},j.prototype.start=function(){this.anim.start()},j.prototype.stop=function(){this.anim.stop()},j.prototype.toggle=function(){return this.anim.isRunning()?(this.anim.stop(),!1):(this.anim.start(),!0)},j.prototype.addCharge=function(a,b,c){var d=new h(a,b,c);this.layer.add(d.shape),this.layer.draw();var e=this;d.onDragEnd=function(){e.isOffScreen(this.getX(),this.getY())?e.anim.simulation.removeFromPlayingField(this.charge):e.anim.simulation.addToPlayingField(this.charge)}},j.prototype.reset=function(){this.puck.moveTo(100+this.map.puckPosition.x,this.map.puckPosition.y),this.puck.velocity=b.Vector.ZERO,this.anim.simulation.reset(),this.layer.draw(),this.puckLayer.draw()},j.prototype.serialize=function(){return this.stage.toJSON()},j.prototype.on=function(a,b){return this.events.hasOwnProperty(a)?(this.events[a].push(b),!0):!1},j.prototype.fire=function(a){if(this.events.hasOwnProperty(a))for(var b=this.events[a],c=0;c<b.length;c++)b[c].call(this)};var k=function(a,b){e(a,function(){var c=new j(a);b(c)})};b.createGame=k}("undefined"==typeof window?global:window);