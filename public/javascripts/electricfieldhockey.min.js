//Electric Field Hockey.js
!function(a){var b=a.EFH||{};"undefined"==typeof a.EFH&&(a.EFH=b);var c=function(a,b){if(b)for(var c in b)a.hasOwnProperty(c)&&(a[c]=b[c])},d={images:{}},e=function(){var a=[{name:"puck",source:"/img/puck.png",type:"image"},{name:"positive",source:"/img/positive.png",type:"image"},{name:"negative",source:"/img/negative.png",type:"image"}],b=0,c=function(c,e,f){b++,"image"===c.type&&(d.images[c.name]=e),b===a.length&&f()};return function(b,d){var e=b||{},f=e.rootDir||"";a.forEach(function(a){if("image"===a.type){var b=new Image;b.onload=function(){c(a,b,d)},b.src=f+a.source}})}}(),f=function(a,c){this.charge=new b.PointCharge({x:a,y:c,charge:1}),this.velocity=b.Vector.ZERO,this.shape=new Kinetic.Image({x:a-20,y:c-20,image:d.images.puck})};f.prototype.moveTo=function(a,b){this.charge.x=a,this.charge.y=b,this.shape.setPosition(a-20,b-20)},f.prototype.getX=function(){return this.charge.x},f.prototype.getY=function(){return this.charge.y},f.prototype.getRadius=function(){return 20};var g=20,h=function(a,c,e){var f=this,h=new b.PointCharge({x:a,y:c,charge:e}),i=new Kinetic.Image({x:a-g,y:c-g,image:e>=0?d.images.positive:d.images.negative,draggable:!0,name:"draggablepoint"});i.createImageHitRegion(),i.on("dragend",function(){h.x=this.getX()+g,h.y=this.getY()+g,"function"==typeof f.onDragEnd&&f.onDragEnd()}),i.on("mousedown touchstart",function(){i.moveToTop()}),this.charge=h,this.shape=i};h.prototype.getX=function(){return this.charge.x},h.prototype.getY=function(){return this.charge.y},h.prototype.getRadius=function(){return g};var i=function(){this.name="Level",this.goal={x:0,y:0,width:25,height:100},this.background={url:null,image:null},this.puckPosition={x:0,y:0},this.startingCharges=[1,-1,1,-1,1,-1],this.width=0,this.height=0};i.load=function(a,b){"string"==typeof a?i.loadJson(a,b):i.loadObject(a,b)},i.loadObject=function(a,b){var d=new i;c(d,a),d.height=+d.height,d.width=+d.width,d.goal.x=+d.goal.x,d.goal.y=+d.goal.y,d.goal.width=+d.goal.width,d.goal.height=+d.goal.height,d.puckPosition.x=+d.puckPosition.x,d.puckPosition.y=+d.puckPosition.y,"string"==typeof a.startingCharges&&(d.startingCharges=a.startingCharges.split(",").map(function(a){return+a})),a.backgroundUrl?(d.background.url=a.backgroundUrl,d.background.image=new Image,d.background.image.onload=function(){b(d)},d.background.image.src=d.background.url):b(d)},i.loadJson=function(){throw"NOT IMPLEMENTED"};var j=function(a){k(this),this.options={container:"efh-simulation",debug:!1},c(this.options,a)},k=function(a){a.stage=null,a.layer=null,a.puckLayer=null,a.anim=null,a.puck=null,a.map=null,a.txt=null,a.events={lose:[],win:[],stop:[],start:[]},a.goal=null,a.dragCharges=[]};j.prototype.init=function(a){var b=this;return b.stage&&b.destroy(),i.load(a,function(a){b.stage=new Kinetic.Stage({width:a.width+100,height:a.height,container:b.options.container}),b.layer=new Kinetic.Layer,b.puckLayer=new Kinetic.Layer,b.puck=new f(100+a.puckPosition.x,a.puckPosition.y),b.puckLayer.add(b.puck.shape),b.goal=new Kinetic.Rect({x:a.goal.x+100,y:a.goal.y,width:a.goal.width,height:a.goal.height,fill:"green"}),b.layer.add(b.goal),b.txt=new Kinetic.Text({x:b.stage.getWidth()-200,y:15,text:"",fontSize:10,fontFamily:"Calibri",fill:"green"}),b.layer.add(b.txt);var c=100,d=0,e=a.width,g=a.height,h=new Kinetic.Line({points:[c,d,c+e,d,c+e,d+g,c,d+g,c,d],stroke:"black",strokeWidth:2});if(b.layer.add(h),b.addInitialCharges(a.startingCharges),a.background.image){var i=new Kinetic.Image({image:a.background.image,x:c,y:d,width:e,height:g});b.layer.add(i),i.moveToBottom(),i.createImageHitRegion(function(){b.layer.draw()})}b.map=a,b.stage.add(b.layer),b.stage.add(b.puckLayer),b.anim=b.createAnimation(),b.layer.draw(),b.puckLayer.draw(),b.reset()}),b},j.prototype.debug=function(a){this.options.debug&&this.txt.setText(a)},j.prototype.isCollision=function(a,b,c){for(var d=8,e=0,f=c+0,g=0;d>g;g++){var h=a+f*Math.cos(e),i=b+f*Math.sin(e),j=this.layer.getIntersection(h,i);if(j&&j.shape&&j.shape!==this.puck.shape)return j.shape;e+=2*Math.PI/d}return!1},j.prototype.checkState=function(a,b){if(this.anim&&this.anim.isRunning()){var c=this.isCollision(a.position.x,a.position.y,this.puck.getRadius());return c?(this.render(a,b.frameRate),this.handleCollision(c),void 0):(this.isOffScreen(a.position.x,a.position.y)&&this.handleCollision("screen"),void 0)}},j.prototype.isOffScreen=function(a,b){return a>100+this.map.width||100>a||b>this.map.height||0>b},j.prototype.createAnimation=function(){var a=this,c={position:{x:a.puck.getX(),y:a.puck.getY()},velocity:a.puck.velocity,acceleration:b.Vector.ZERO,charge:a.puck.charge},d=new b.Simulation(c,function(b,c){a.checkState(b,c)}),e=new Kinetic.Animation(function(b){if(0!==b.timeDiff){var c=d.handleFrameRequest(b);a.render(c,b.frameRate)}},a.layer);return e.simulation=d,e},j.prototype.render=function(a,b){this.puck.velocity=a.velocity,this.puck.moveTo(a.position.x,a.position.y),this.puckLayer.draw(),this.debug("FPS: "+b)},j.prototype.handleCollision=function(a){this.stop(),a!==!1?a==this.goal?this.fire("win"):this.fire("lose"):this.fire("lose")},j.prototype.addInitialCharges=function(a){for(var b=25,c=25,d=0;d<a.length;d++)this.addCharge(b,c,a[d]),c+=20},j.prototype.start=function(){this.fire("start"),this.dragCharges.forEach(function(a){a.shape.setDraggable(!1)}),this.anim.start()},j.prototype.stop=function(){this.fire("stop"),this.dragCharges.forEach(function(a){a.shape.setDraggable(!0)}),this.anim.stop()},j.prototype.toggle=function(){return this.anim.isRunning()?(this.stop(),!1):(this.start(),!0)},j.prototype.addCharge=function(a,b,c){var d=new h(a,b,c);this.layer.add(d.shape),this.layer.draw();var e=this;return d.onDragEnd=function(){e.isOffScreen(this.getX(),this.getY())?e.anim.simulation.removeFromPlayingField(this.charge):e.anim.simulation.addToPlayingField(this.charge)},this.dragCharges.push(d),d},j.prototype.reset=function(){this.puck.moveTo(100+this.map.puckPosition.x,this.map.puckPosition.y),this.puck.velocity=b.Vector.ZERO,this.anim.simulation.reset(),this.layer.draw(),this.puckLayer.draw()},j.prototype.serialize=function(){return this.anim.simulation.serialize()},j.prototype.deserialize=function(a){var b=JSON.parse(a),c=this;b.charges.forEach(function(a){var b=c.addCharge(a.x,a.y,a.charge);c.anim.simulation.addToPlayingField(b.charge)})},j.prototype.on=function(a,b){return this.events.hasOwnProperty(a)?(this.events[a].push(b),!0):!1},j.prototype.fire=function(a){if(this.events.hasOwnProperty(a))for(var b=this.events[a],c=0;c<b.length;c++)b[c].call(this)};var l=function(a,b){e(a,function(){var c=new j(a);b(c)})};j.prototype.destroy=function(){this.stage.destroy(),this.stage.destroyChildren(),k(this)},b.createGame=l}("undefined"==typeof window?global:window),function(a){var b=a.EFH||{};"undefined"==typeof a.EFH&&(a.EFH=b);var c=function(a,b){if(b)for(var c in b)a.hasOwnProperty(c)&&(a[c]=b[c])},d=function(a){this.magnitude=0,this.direction=0,c(this,a)};d.prototype.toString=function(){return"Vector: "+this.magnitude.toFixed(2)+" @ "+(180*this.direction/Math.PI).toFixed(2)},d.prototype.add=function(a){if(0===a.magnitude)return new d({magnitude:this.magnitude,direction:this.direction});var b=this.xComponent()+a.xComponent(),c=this.yComponent()+a.yComponent(),e=Math.atan2(c,b),f=Math.sqrt(b*b+c*c);return new d({magnitude:f,direction:e}).standardize()},d.prototype.mult=function(a){return new d({magnitude:this.magnitude*a,direction:this.direction}).standardize()},d.prototype.xComponent=function(){return this.magnitude*Math.cos(this.direction)},d.prototype.yComponent=function(){return this.magnitude*Math.sin(this.direction)},d.ZERO=new d({magnitude:0,direction:0}),d.prototype.standardize=function(){var a=this.direction,b=this.magnitude;0>b&&(b=Math.abs(b),a+=Math.PI);for(var c=0>a?2*Math.PI:-2*Math.PI;0>a||a>2*Math.PI;)a+=c;var e=new d({magnitude:b,direction:a});return e.nonstandard=this,e},d.fromComponent=function(a,b){return new d({magnitude:Math.sqrt(a*a+b*b),direction:Math.atan2(b,a)}).standardize()},b.Vector=d;var e=1e6,f=function(a){this.x=0,this.y=0,this.charge=1,c(this,a)};f.prototype.calcForceAgainst=function(a){var b=a.x-this.x,c=a.y-this.y,f=Math.sqrt(b*b+c*c),g=Math.atan2(c,b),h=e*this.charge*a.charge/(f*f);return h==Number.POSITIVE_INFINITY&&(h=Number.MAX_VALUE),new d({magnitude:h,direction:g}).standardize()},f.prototype.calcForceFrom=function(a){var b=this;return 0===a.length?d.ZERO:a.map(function(a){return a.calcForceAgainst(b)}).reduce(function(a,b){return a.add(b)},d.ZERO).standardize()},b.PointCharge=f,b.K=e;var g={};g.calcPosition=function(a,b,c,d){return{x:a.x+(b.xComponent()*d+c.xComponent()*d*d),y:a.y+(b.yComponent()*d+c.yComponent()*d*d)}},g.calcVelocity=function(a,b,c){return a.add(b.mult(c))},b.Physics=g;var h=function(a,b){this.charges=[],this.initialState=a,this.currentState=a,this.previousState=a,this.accumulator=0,this.simrate=1e3/60,this.onStep=b||function(){}};h.prototype.reset=function(){this.currentState=this.previousState=this.initialState,this.accumulator=0},h.prototype.step=function(a,b){var c=b/1e3;if(0===c)return a;var d=new f({x:a.position.x,y:a.position.y,charge:a.charge.charge}).calcForceFrom(this.charges),e=g.calcPosition(a.position,a.velocity,d,c),h=d,i=g.calcVelocity(a.velocity,d,c);return{position:e,velocity:i,acceleration:h,charge:a.charge}},h.prototype.handleFrameRequest=function(a){var b=a.timeDiff>250?250:a.timeDiff;for(this.accumulator+=b;this.accumulator>=this.simrate;)this.previousState=this.currentState,this.currentState=this.step(this.currentState,this.simrate),this.accumulator-=this.simrate,this.onStep(this.currentState,a);var c=this.accumulator/b,d=this.blend(this.previousState,this.currentState,c);return d},h.prototype.blend=function(a,b,c){var e=d.fromComponent(a.position.x,a.position.y),f=d.fromComponent(b.position.x,b.position.y),g=f.mult(c).add(e.mult(1-c));return{velocity:b.velocity,acceleration:b.acceleration,position:{x:g.xComponent(),y:g.yComponent()}}},h.prototype.addToPlayingField=function(a){-1===this.charges.indexOf(a)&&this.charges.push(a)},h.prototype.removeFromPlayingField=function(a){var b=this.charges.indexOf(a);b>-1&&this.charges.splice(b,1)},h.prototype.serialize=function(){return JSON.stringify({charges:this.charges})},b.Simulation=h}("undefined"==typeof window?global:window);